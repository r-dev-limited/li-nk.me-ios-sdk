name: Release

on:
  push:
    tags:
      - "v*"
      - "ios-v*"
  workflow_dispatch:
    inputs:
      tag:
        description: 'Git tag to release (e.g., v1.0.0 or ios-v1.0.0)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  release:
    name: Release iOS SDK
    runs-on: macos-14
    env:
      COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Verify tag exists
        if: github.event_name == 'workflow_dispatch'
        shell: bash
        run: |
          TAG="${{ github.event.inputs.tag }}"
          if ! git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag '$TAG' not found. Fetching all tags..."
            git fetch --tags
            if ! git rev-parse "$TAG" >/dev/null 2>&1; then
              echo "Error: Tag '$TAG' does not exist in the repository." >&2
              echo "Available tags:" >&2
              git tag -l | head -20 >&2
              exit 1
            fi
          fi
          git checkout "$TAG"

      - name: Validate tag matches LinkMeKit.podspec
        shell: bash
        run: |
          if [[ -n "${{ github.event.inputs.tag }}" ]]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG="${GITHUB_REF_NAME}"
          fi

          if [[ "$TAG" == ios-v* ]]; then
            TAG_VERSION="${TAG#ios-v}"
          elif [[ "$TAG" == v* ]]; then
            TAG_VERSION="${TAG#v}"
          else
            echo "Tag '${TAG}' must start with 'v' or 'ios-v'." >&2
            exit 1
          fi

          SPEC_VERSION=$(awk -F'"' '/^\s*s\.version/ {print $2; exit}' LinkMeKit/LinkMeKit.podspec)

          echo "Tag version: ${TAG_VERSION}"
          echo "Podspec version: ${SPEC_VERSION}"

          if [[ "${TAG_VERSION}" != "${SPEC_VERSION}" ]]; then
            echo "Tag (${TAG_VERSION}) does not match LinkMeKit.podspec version (${SPEC_VERSION})." >&2
            exit 1
          fi

      - name: Build Swift Package (validate compilation)
        shell: bash
        run: |
          pushd LinkMeKit
          swift build
          popd

      - name: Swift tests
        shell: bash
        run: |
          pushd LinkMeKit
          swift test
          popd

      - name: Pod lib lint
        shell: bash
        run: |
          pushd LinkMeKit
          pod lib lint LinkMeKit.podspec --allow-warnings
          popd

      - name: Pod trunk push
        shell: bash
        run: |
          pushd LinkMeKit
          pod trunk push LinkMeKit.podspec --allow-warnings
          popd
